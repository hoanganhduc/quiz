import { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from "react/jsx-runtime";
import { useState } from "react";
import { Link, NavLink } from "react-router-dom";
import clsx from "clsx";
import { githubLoginUrl, googleLoginUrl, logout } from "../../api";
import { Badge } from "../ui/Badge";
import { IconClock, IconLogin, IconLogout, IconMenu, IconPlay, IconQuestion, IconSettings, IconShield, IconUser, IconX } from "../ui/Icons";
import { HelpDrawer } from "./HelpDrawer";
function navLinkClass({ isActive }) {
    return clsx("inline-flex items-center rounded-lg px-3 py-2 text-sm border min-h-[44px]", "focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-neutral-900", isActive
        ? "bg-muted border-border text-text"
        : "bg-transparent border-transparent hover:bg-muted text-textMuted");
}
function mobileNavLinkClass({ isActive }) {
    return clsx("flex items-center gap-3 rounded-lg px-4 py-3 text-base border min-h-[48px] w-full", "focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500", isActive
        ? "bg-muted border-border text-text font-medium"
        : "bg-transparent border-transparent hover:bg-muted text-textMuted");
}
export function TopBar({ session }) {
    const [helpOpen, setHelpOpen] = useState(false);
    const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
    const isAdmin = !!session?.roles?.includes("admin");
    const apiBase = import.meta.env.VITE_API_BASE;
    const displayName = !session
        ? null
        : session.provider === "anon"
            ? "Anonymous"
            : session.displayName ?? session.name ?? session.username ?? "User";
    const handleLogout = async () => {
        if (!apiBase)
            return;
        await logout();
        window.location.reload();
    };
    const startGithubLogin = () => {
        if (!apiBase)
            return;
        window.location.href = githubLoginUrl(window.location.href);
    };
    const startGoogleLogin = () => {
        if (!apiBase)
            return;
        window.location.href = googleLoginUrl(window.location.href);
    };
    const closeMobileMenu = () => setMobileMenuOpen(false);
    const navItems = (_jsxs(_Fragment, { children: [_jsx(NavLink, { to: "/", className: navLinkClass, end: true, children: _jsxs("span", { className: "inline-flex items-center gap-2", children: [_jsx(IconPlay, { className: "h-4 w-4" }), _jsx("span", { children: "Take Exam" })] }) }), session ? (_jsxs(_Fragment, { children: [_jsx(NavLink, { to: "/history", className: navLinkClass, children: _jsxs("span", { className: "inline-flex items-center gap-2", children: [_jsx(IconClock, { className: "h-4 w-4" }), _jsx("span", { children: "My History" })] }) }), _jsx(NavLink, { to: "/account", className: navLinkClass, children: _jsxs("span", { className: "inline-flex items-center gap-2", children: [_jsx(IconUser, { className: "h-4 w-4" }), _jsx("span", { children: "Account" })] }) }), isAdmin ? (_jsx(NavLink, { to: "/admin", className: navLinkClass, children: _jsxs("span", { className: "inline-flex items-center gap-2", children: [_jsx(IconShield, { className: "h-4 w-4" }), _jsx("span", { children: "Admin" })] }) })) : null, _jsx(NavLink, { to: "/settings", className: navLinkClass, children: _jsxs("span", { className: "inline-flex items-center gap-2", children: [_jsx(IconSettings, { className: "h-4 w-4" }), _jsx("span", { children: "Settings" })] }) })] })) : null] }));
    const mobileNavItems = (_jsxs(_Fragment, { children: [_jsxs(NavLink, { to: "/", className: mobileNavLinkClass, end: true, onClick: closeMobileMenu, children: [_jsx(IconPlay, { className: "h-5 w-5" }), _jsx("span", { children: "Take Exam" })] }), session ? (_jsxs(_Fragment, { children: [_jsxs(NavLink, { to: "/history", className: mobileNavLinkClass, onClick: closeMobileMenu, children: [_jsx(IconClock, { className: "h-5 w-5" }), _jsx("span", { children: "My History" })] }), _jsxs(NavLink, { to: "/account", className: mobileNavLinkClass, onClick: closeMobileMenu, children: [_jsx(IconUser, { className: "h-5 w-5" }), _jsx("span", { children: "Account" })] }), isAdmin ? (_jsxs(NavLink, { to: "/admin", className: mobileNavLinkClass, onClick: closeMobileMenu, children: [_jsx(IconShield, { className: "h-5 w-5" }), _jsx("span", { children: "Admin" })] })) : null, _jsxs(NavLink, { to: "/settings", className: mobileNavLinkClass, onClick: closeMobileMenu, children: [_jsx(IconSettings, { className: "h-5 w-5" }), _jsx("span", { children: "Settings" })] })] })) : null] }));
    return (_jsxs(_Fragment, { children: [_jsx("header", { className: "sticky top-0 z-40 border-b border-border bg-card/80 backdrop-blur", children: _jsxs("div", { className: "mx-auto max-w-6xl px-4 py-3 flex items-center justify-between gap-3", children: [_jsxs("div", { className: "flex items-center gap-4", children: [_jsx(Link, { to: "/", className: "font-semibold text-text text-lg", children: "Quiz" }), _jsx("nav", { className: "hidden md:flex flex-wrap items-center gap-1", children: navItems })] }), _jsxs("div", { className: "flex items-center gap-2", children: [_jsx("button", { type: "button", className: clsx(navLinkClass({ isActive: false }), "hidden sm:inline-flex"), onClick: () => setHelpOpen(true), children: _jsxs("span", { className: "inline-flex items-center gap-2", children: [_jsx(IconQuestion, { className: "h-4 w-4" }), _jsx("span", { children: "Help" })] }) }), session ? (_jsxs(_Fragment, { children: [_jsxs(Link, { to: "/account", className: "hidden sm:inline-flex items-center gap-2 rounded-full border border-border bg-muted px-3 py-1.5 text-sm text-text hover:bg-muted/70 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-neutral-900", children: [_jsx("span", { className: "truncate max-w-[150px]", children: displayName }), _jsx(Badge, { tone: isAdmin ? "info" : "muted", children: isAdmin ? "Admin" : "User" })] }), _jsx("button", { type: "button", className: clsx(navLinkClass({ isActive: false }), "hidden md:inline-flex"), onClick: handleLogout, children: _jsxs("span", { className: "inline-flex items-center gap-2", children: [_jsx(IconLogout, { className: "h-4 w-4" }), _jsx("span", { children: "Logout" })] }) })] })) : (_jsx(_Fragment, { children: _jsxs("details", { className: "relative hidden md:block", children: [_jsx("summary", { className: clsx(navLinkClass({ isActive: false }), "cursor-pointer list-none [&_::-webkit-details-marker]:hidden"), children: "Sign in" }), _jsxs("div", { className: "absolute right-0 mt-2 w-72 overflow-hidden rounded-lg border border-border bg-card shadow-[0_12px_32px_rgba(0,0,0,0.20)] dark:shadow-[0_12px_32px_rgba(0,0,0,0.60)]", children: [_jsx("div", { className: "px-3 py-2 text-xs font-medium text-textMuted", children: "Sign in with" }), _jsxs("div", { className: "p-1 space-y-1", children: [_jsx("button", { type: "button", disabled: !apiBase, className: "w-full rounded-md border border-transparent bg-transparent px-3 py-3 text-left text-sm font-medium text-text transition-colors hover:bg-muted hover:border-border focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-card disabled:pointer-events-none disabled:opacity-50 min-h-[44px]", onClick: startGithubLogin, children: _jsxs("span", { className: "flex items-center justify-between gap-3", children: [_jsxs("span", { className: "inline-flex items-center gap-2", children: [_jsx(IconLogin, { className: "h-4 w-4 text-textMuted" }), _jsx("span", { children: "Continue with GitHub" })] }), _jsx("span", { className: "text-textMuted", children: "\u2192" })] }) }), _jsx("button", { type: "button", disabled: !apiBase, className: "w-full rounded-md border border-transparent bg-transparent px-3 py-3 text-left text-sm font-medium text-text transition-colors hover:bg-muted hover:border-border focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-card disabled:pointer-events-none disabled:opacity-50 min-h-[44px]", onClick: startGoogleLogin, children: _jsxs("span", { className: "flex items-center justify-between gap-3", children: [_jsxs("span", { className: "inline-flex items-center gap-2", children: [_jsx(IconLogin, { className: "h-4 w-4 text-textMuted" }), _jsx("span", { children: "Continue with Google" })] }), _jsx("span", { className: "text-textMuted", children: "\u2192" })] }) })] })] })] }) })), _jsx("button", { type: "button", className: "md:hidden inline-flex items-center justify-center rounded-lg p-2 min-h-[44px] min-w-[44px] text-textMuted hover:bg-muted border border-transparent hover:border-border focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500", onClick: () => setMobileMenuOpen(true), "aria-label": "Open menu", children: _jsx(IconMenu, { className: "h-6 w-6" }) })] })] }) }), mobileMenuOpen && (_jsxs("div", { className: "fixed inset-0 z-50 md:hidden", children: [_jsx("div", { className: "absolute inset-0 bg-black/50 backdrop-blur-sm", onClick: closeMobileMenu }), _jsxs("div", { className: "absolute right-0 top-0 h-full w-[280px] max-w-[85vw] bg-card border-l border-border shadow-2xl overflow-y-auto", children: [_jsxs("div", { className: "flex items-center justify-between px-4 py-4 border-b border-border", children: [_jsx("span", { className: "font-semibold text-text text-lg", children: "Menu" }), _jsx("button", { type: "button", className: "inline-flex items-center justify-center rounded-lg p-2 min-h-[44px] min-w-[44px] text-textMuted hover:bg-muted border border-transparent hover:border-border", onClick: closeMobileMenu, "aria-label": "Close menu", children: _jsx(IconX, { className: "h-6 w-6" }) })] }), session && (_jsx("div", { className: "px-4 py-3 border-b border-border", children: _jsxs("div", { className: "flex items-center gap-2", children: [_jsx("span", { className: "text-sm text-text font-medium truncate", children: displayName }), _jsx(Badge, { tone: isAdmin ? "info" : "muted", className: "text-xs", children: isAdmin ? "Admin" : "User" })] }) })), _jsx("nav", { className: "p-2 space-y-1", children: mobileNavItems }), _jsx("div", { className: "p-2 border-t border-border", children: _jsxs("button", { type: "button", className: mobileNavLinkClass({ isActive: false }), onClick: () => { closeMobileMenu(); setHelpOpen(true); }, children: [_jsx(IconQuestion, { className: "h-5 w-5" }), _jsx("span", { children: "Help" })] }) }), _jsx("div", { className: "p-2 border-t border-border", children: session ? (_jsxs("button", { type: "button", className: clsx(mobileNavLinkClass({ isActive: false }), "text-error"), onClick: () => { closeMobileMenu(); handleLogout(); }, children: [_jsx(IconLogout, { className: "h-5 w-5" }), _jsx("span", { children: "Logout" })] })) : (_jsxs("div", { className: "space-y-1", children: [_jsxs("button", { type: "button", disabled: !apiBase, className: mobileNavLinkClass({ isActive: false }), onClick: startGithubLogin, children: [_jsx(IconLogin, { className: "h-5 w-5" }), _jsx("span", { children: "Sign in with GitHub" })] }), _jsxs("button", { type: "button", disabled: !apiBase, className: mobileNavLinkClass({ isActive: false }), onClick: startGoogleLogin, children: [_jsx(IconLogin, { className: "h-5 w-5" }), _jsx("span", { children: "Sign in with Google" })] })] })) })] })] })), _jsx(HelpDrawer, { open: helpOpen, onClose: () => setHelpOpen(false) })] }));
}
